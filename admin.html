<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin - Agenda Maura</title>
<style>
  :root{--rosa:#ff5fa2; --fondo:#fff0f6; --card:#fff;}
  body{font-family:Inter, "Poppins", sans-serif; background:var(--fondo); margin:0; padding:28px; display:flex; justify-content:center;}
  .wrap{width:100%; max-width:1100px;}
  .loginBox, .panel{background:var(--card); border-radius:12px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.08);}
  .loginBox{max-width:420px; margin:0 auto;}
  h1{color:var(--rosa); margin:0 0 12px; text-align:center;}
  input[type="password"]{width:100%; padding:10px; border-radius:8px; border:1px solid #e7d6df; margin-top:8px;}
  button{background:var(--rosa); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;}
  .topControls{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px;}
  .calBox{display:flex; gap:20px; flex-direction:column;}
  .calHeader{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;}
  .calGrid{display:grid; grid-template-columns:repeat(7,1fr); gap:8px;}
  .day{background:#fff; padding:14px; border-radius:10px; border:1px solid #ffe4ef; min-height:84px; position:relative; cursor:pointer;}
  .day.empty{background:transparent;border:none; cursor:default;}
  .day .num{font-weight:700; color:var(--rosa);}
  .day.marked{background:var(--rosa); color:white;}
  .monthNav button{background:transparent;color:var(--rosa);border:1px solid var(--rosa);padding:6px 10px;border-radius:8px;cursor:pointer;}
  .sidePanel{margin-top:16px; background:#fff; padding:12px; border-radius:10px;}
  table{width:100%; border-collapse:collapse;}
  th,td{padding:8px; border-bottom:1px solid #f2e6ec; text-align:left;}
  .actions button{margin-right:6px; padding:6px 8px; border-radius:8px; border:none; cursor:pointer;}
  .actions .edit{background:#fff2f6; color:var(--rosa);}
  .actions .del{background:#ff6b7f; color:white;}
  /* modal */
  .modalBg{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); justify-content:center; align-items:center;}
  .modal{background:#fff; padding:18px; border-radius:12px; width:320px; box-shadow:0 10px 30px rgba(0,0,0,0.15);}
  .field{margin-top:8px;}
  .field input, .field select{width:100%; padding:8px; border-radius:8px; border:1px solid #e7d6df;}
  .row{display:flex; gap:8px; margin-top:12px;}
  .muted{color:#666; font-size:13px;}
</style>
</head>
<body>
<div class="wrap">

  <!-- LOGIN -->
  <div id="loginBox" class="loginBox">
    <h1>Acceso Admin</h1>
    <input id="pwd" type="password" placeholder="Ingrese contraseña">
    <div style="margin-top:10px; text-align:center;">
      <button onclick="login()">Entrar</button>
    </div>
    <p id="err" class="muted" style="color:#b00020; text-align:center; margin-top:8px;"></p>
  </div>

  <!-- PANEL -->
  <div id="panel" class="panel" style="display:none; margin-top:18px;">
    <div class="calBox">
      <div class="calHeader">
        <div class="monthNav">
          <button onclick="goPrevMonth()">◀</button>
          <button onclick="goNextMonth()">▶</button>
        </div>
        <div style="font-weight:800; font-size:18px;" id="monthLabel"></div>
        <div>
          <button onclick="openCreateModal()">➕ Añadir cita</button>
        </div>
      </div>

      <!-- Días de la semana -->
      <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-bottom:8px;">
        <div class="muted" style="text-align:center;">Dom</div><div class="muted" style="text-align:center;">Lun</div>
        <div class="muted" style="text-align:center;">Mar</div><div class="muted" style="text-align:center;">Mié</div>
        <div class="muted" style="text-align:center;">Jue</div><div class="muted" style="text-align:center;">Vie</div>
        <div class="muted" style="text-align:center;">Sáb</div>
      </div>

      <!-- Grid -->
      <div id="calGrid" class="calGrid"></div>

      <!-- Panel inferior: citas del día -->
      <div id="dayPanel" class="sidePanel" style="display:none;">
        <h3 id="dayTitle">Citas</h3>
        <div id="dayCitas"></div>
      </div>
    </div>
  </div>

</div>

<!-- Modal editar/crear -->
<div id="modalBg" class="modalBg" style="display:none; align-items:center;">
  <div class="modal">
    <h3 id="modalTitle">Editar cita</h3>

    <div class="field">
      <label>Nombre</label>
      <input id="mNombre" type="text">
    </div>
    <div class="field">
      <label>Teléfono</label>
      <input id="mTelefono" type="text" placeholder="88888888">
    </div>
    <div class="field">
      <label>Fecha</label>
      <input id="mFecha" type="date">
    </div>
    <div class="field">
      <label>Hora</label>
      <select id="mHora"></select>
    </div>

    <div class="row" style="justify-content:flex-end;">
      <button onclick="closeModal()" style="background:#eee;color:#333;">Cancelar</button>
      <button onclick="saveModal()" style="background:var(--rosa); color:white;">Guardar</button>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const PASSWORD = "Maura@205";

/* horarios */
const horasLunASab = [
  "09:30","10:00","10:30","11:00","11:30","12:00","12:30",
  "13:00","13:30","14:00","14:30","15:00","15:30","16:00",
  "16:30","17:00","17:30","18:00","18:30","19:00"
];
const horasDom = [
  "10:30","11:00","11:30","12:00","12:30","13:00","13:30",
  "14:00","14:30","15:00","15:30","16:00"
];

/* ---------- Estado ---------- */
let visibleStart = new Date(); // mes que se muestra (primer día del mes)
visibleStart.setDate(1);
let endLimit = new Date(); endLimit.setFullYear(endLimit.getFullYear() + 1); // un año adelante

/* ---------- LOGIN ---------- */
function login() {
  const val = document.getElementById('pwd').value;
  if (val === PASSWORD) {
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('panel').style.display = 'block';
    renderCalendar();
  } else {
    document.getElementById('err').textContent = 'Contraseña incorrecta';
  }
}

/* ---------- STORAGE ---------- */
function readAppointments() {
  return JSON.parse(localStorage.getItem('appointments') || '[]');
}
function writeAppointments(arr) {
  localStorage.setItem('appointments', JSON.stringify(arr));
}

/* ---------- Helpers ---------- */
function pad(n){return String(n).padStart(2,'0');}
function formatoYYYYMMDD(d) {
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

/* ---------- Calendar rendering ---------- */
function renderCalendar() {
  const calGrid = document.getElementById('calGrid');
  calGrid.innerHTML = '';
  const monthLabel = document.getElementById('monthLabel');
  const year = visibleStart.getFullYear();
  const month = visibleStart.getMonth();
  const monthNames = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  monthLabel.textContent = `${monthNames[month]} ${year}`;

  // primer día de la semana (0..6)
  const primerDia = new Date(year, month, 1).getDay();
  const diasEnMes = new Date(year, month+1, 0).getDate();

  // Fill empty cells before first day
  for (let i=0;i<primerDia;i++){
    const empty = document.createElement('div'); empty.classList.add('day','empty'); calGrid.appendChild(empty);
  }

  const appointments = readAppointments();

  for (let day=1; day<=diasEnMes; day++){
    const d = new Date(year, month, day);
    const dateKey = formatoYYYYMMDD(d);
    const dayDiv = document.createElement('div');
    dayDiv.classList.add('day');
    // show number
    const num = document.createElement('div'); num.classList.add('num'); num.textContent = day;
    dayDiv.appendChild(num);

    // contar citas en ese día
    const citasDia = appointments.filter(a => a.fecha === dateKey);
    if (citasDia.length > 0) {
      dayDiv.classList.add('marked');
      const badge = document.createElement('div'); badge.style.position='absolute'; badge.style.top='8px'; badge.style.right='8px'; badge.style.background='rgba(255,255,255,0.15)'; badge.style.padding='4px 6px'; badge.style.borderRadius='8px'; badge.style.fontSize='12px';
      badge.textContent = `${citasDia.length}`;
      dayDiv.appendChild(badge);
    }

    // click -> mostrar panel del día
    dayDiv.addEventListener('click', () => showDay(dateKey, d));

    calGrid.appendChild(dayDiv);
  }
}

/* ---------- Navegación meses (solo dentro del rango de 1 año) ---------- */
function goNextMonth() {
  const next = new Date(visibleStart.getFullYear(), visibleStart.getMonth() + 1, 1);
  // no pasar límite > endLimit (mes y año)
  const lastAllowed = new Date(endLimit.getFullYear(), endLimit.getMonth(), 1);
  if (next > lastAllowed) return alert('Rango máximo: +1 año');
  visibleStart = next;
  renderCalendar();
  hideDayPanel();
}
function goPrevMonth() {
  const prev = new Date(visibleStart.getFullYear(), visibleStart.getMonth() - 1, 1);
  const firstAllowed = new Date(); firstAllowed.setDate(1); // mes actual como mínimo
  const firstAllowedMonthStart = new Date(firstAllowed.getFullYear(), firstAllowed.getMonth(), 1);
  if (prev < firstAllowedMonthStart) return alert('No se puede retroceder antes del mes actual');
  visibleStart = prev;
  renderCalendar();
  hideDayPanel();
}

/* ---------- Mostrar citas del día ---------- */
function showDay(dateKey, dateObj){
  const panel = document.getElementById('dayPanel');
  const title = document.getElementById('dayTitle');
  const dayCitas = document.getElementById('dayCitas');

  title.textContent = `Citas: ${dateKey}`;
  const appointments = readAppointments().filter(a => a.fecha === dateKey);
  dayCitas.innerHTML = '';

  if (appointments.length === 0) {
    dayCitas.innerHTML = '<div class="muted">No hay citas</div>';
  } else {
    const table = document.createElement('table');
    appointments.forEach(a => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="width:35%;"><strong>${a.hora}</strong></td>
        <td style="width:45%;">${a.nombre}<div class="muted">${a.telefono}</div></td>
        <td style="width:20%; text-align:right;" class="actions">
          <button class="edit" onclick="openEditModal('${a.id}')">Editar</button>
          <button class="del" onclick="deleteAppointment('${a.id}')">Borrar</button>
        </td>
      `;
      table.appendChild(tr);
    });
    dayCitas.appendChild(table);
  }

  panel.style.display = 'block';
}

/* ---------- Ocultar panel día ---------- */
function hideDayPanel(){ document.getElementById('dayPanel').style.display='none'; }

/* ---------- Abrir modal crear ---------- */
function openCreateModal() {
  openModal(); // sin id indica crear
}

/* ---------- Modal management ---------- */
const modalBg = document.getElementById('modalBg');
const modalTitle = document.getElementById('modalTitle');
const mNombre = document.getElementById('mNombre');
const mTelefono = document.getElementById('mTelefono');
const mFecha = document.getElementById('mFecha');
const mHora = document.getElementById('mHora');
let editingId = null;

function openModal(id = null) {
  editingId = id;
  modalBg.style.display = 'flex';
  // set date min/max
  const hoy = new Date();
  const max = new Date(); max.setFullYear(max.getFullYear()+1);
  mFecha.min = formatoYYYYMMDD(hoy);
  mFecha.max = formatoYYYYMMDD(max);

  if (id) {
    modalTitle.textContent = 'Editar cita';
    const a = readAppointments().find(x => x.id === id);
    if (!a) return alert('Cita no encontrada');
    mNombre.value = a.nombre;
    mTelefono.value = a.telefono;
    mFecha.value = a.fecha;
    populateHoursForDate(mFecha.value, a.hora);
  } else {
    modalTitle.textContent = 'Crear nueva cita';
    mNombre.value = '';
    mTelefono.value = '';
    mFecha.value = formatoYYYYMMDD(new Date());
    populateHoursForDate(mFecha.value);
  }
}

/* Close */
function closeModal() {
  modalBg.style.display = 'none';
  editingId = null;
}

/* Populate hours based on selected mFecha */
mFecha.addEventListener('change', ()=> populateHoursForDate(mFecha.value));

function populateHoursForDate(fechaStr, selectedHour = null) {
  mHora.innerHTML = '';
  if (!fechaStr) return;
  const d = new Date(fechaStr + 'T00:00:00');
  const dia = d.getDay();
  const list = (dia === 0) ? horasDom : horasLunASab;
  list.forEach(h => {
    const o = document.createElement('option'); o.value = h; o.textContent = h; mHora.appendChild(o);
  });
  if (selectedHour) mHora.value = selectedHour;
}

/* ---------- Save modal (create or update) ---------- */
function saveModal() {
  const nombre = mNombre.value.trim();
  const telefono = mTelefono.value.trim();
  const fecha = mFecha.value;
  const hora = mHora.value;

  if (!nombre || !telefono || !fecha || !hora) return alert('Completa todos los campos.');

  // validación rango fecha
  const minD = new Date(mFecha.min + 'T00:00:00');
  const maxD = new Date(mFecha.max + 'T00:00:00');
  const sel = new Date(fecha + 'T00:00:00');
  if (sel < minD || sel > maxD) return alert('Fecha fuera del rango permitido.');

  let appointments = readAppointments();

  // evitar duplicado fecha+hora (si es creación o si es edición y no se está editando el mismo id)
  const conflicto = appointments.find(a => a.fecha === fecha && a.hora === hora && a.id !== editingId);
  if (conflicto) return alert('Ya existe una cita en esa fecha y hora.');

  if (editingId) {
    // actualizar
    appointments = appointments.map(a => {
      if (a.id === editingId) {
        return {...a, nombre, telefono, fecha, hora};
      }
      return a;
    });
    writeAppointments(appointments);
    closeModal();
    renderCalendar();
    // si el panel del día está abierto y coincide la fecha, actualizarlo
    const panelTitle = document.getElementById('dayTitle').textContent.replace('Citas: ','');
    if (panelTitle === fecha) showDay(fecha, new Date(fecha + 'T00:00:00'));
  } else {
    // crear
    const id = Date.now().toString(36) + Math.floor(Math.random()*1000).toString(36);
    appointments.push({id, nombre, telefono, fecha, hora});
    writeAppointments(appointments);
    closeModal();
    renderCalendar();
  }
}

/* ---------- Delete appointment ---------- */
function deleteAppointment(id) {
  if (!confirm('Eliminar esta cita?')) return;
  let appointments = readAppointments();
  appointments = appointments.filter(a => a.id !== id);
  writeAppointments(appointments);
  // refrescar panel si abierto
  const panelTitle = document.getElementById('dayTitle').textContent.replace('Citas: ','');
  renderCalendar();
  if (panelTitle) showDay(panelTitle, new Date(panelTitle + 'T00:00:00'));
}

/* ---------- Open edit modal by id ---------- */
function openEditModal(id) { openModal(id); }

/* ---------- Inicializar: limitar meses a 12 meses desde hoy ---------- */
(function init(){
  // Ensurar visibleStart sea primer dia del mes actual
  const now = new Date();
  visibleStart = new Date(now.getFullYear(), now.getMonth(), 1);
  renderCalendar();
})();
</script>

</body>
</html>
